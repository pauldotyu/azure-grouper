# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml


trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
- group: kvdevops1

stages:
- stage: tools
  condition: ne(variables.workspace, '')
  displayName: Tools
  jobs:
  - job: install_tools
    displayName: Install Tools
    steps:
    - script: |
        #curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az --version
      displayName: Install Azure CLI
      name: install_azcli
    - script: |
        #curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
        #sudo apt-add-repository "deb [arch=$(dpkg --print-architecture)] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
        #sudo apt install terraform
        terraform --version
      displayName: Install Terraform
      name: install_terraform
    - script: |
        docker --version
      displayName: Install Docker
      name: install_docker
    - script: |
        kubectl version --client
      displayName: Install kubectl
      name: install_kubectl
    - script: |
        #wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
        #sudo dpkg -i packages-microsoft-prod.deb
        #sudo apt install apt-transport-https
        #sudo apt update
        #sudo apt install msopenjdk-11
        java --version
      displayName: Install Java
      name: install_java
- stage: plan
  displayName: Plan
  condition: and(eq(dependencies.tools.result, 'Succeeded'), eq(variables.destroy, false))
  dependsOn: tools
  jobs: 
  - job: terraform_plan
    displayName: Terraform Plan 
    steps:
    - script: |
        echo "##vso[task.setvariable variable=PSQL_PASSWORD_GROUPER_ENCRYPTED;]$(java -cp .:grouperClient-2.5.39.jar edu.internet2.middleware.morphString.Encrypt dontMask <<< $(psql-password) | sed 's/Type the string to encrypt (note: pasting might echo it back): The encrypted string is: //')"
      displayName: Grouper encrypt passwords
      name: grouper_encrypt
      workingDirectory: slashRoot/opt/grouper/grouperWebapp/WEB-INF/classes
    - task: DownloadSecureFile@1
      name: terraformrc
      displayName: 'Download .terraformrc'
      inputs:
        secureFile: '.terraformrc'
    - script: |
        export ARM_CLIENT_ID=$(client-id) 
        export ARM_CLIENT_SECRET=$(client-secret)
        export ARM_SUBSCRIPTION_ID=$(main-subscription-id)
        export ARM_TENANT_ID=$(tenant-id)
        terraform init
        terraform workspace select $(workspace) || terraform workspace new $(workspace)
        terraform plan -var-file="$(workspace).tfvars" -var="psql_login=$(psql-user)" -var="psql_password=$(psql-password)" -var="psql_password_grouper_encrypted=$(PSQL_PASSWORD_GROUPER_ENCRYPTED)" -out=$(System.DefaultWorkingDirectory)/$(workspace).tfplan
      displayName: Terraform Plan
      name: terraform_plan
      workingDirectory: terraform
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/$(workspace).tfplan'
        artifactName: 'tfplan'
      displayName: Publish $(workspace).tfplan
      name: publish_tfplan
